/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package com.zx.shopmanagementsystem.forms;

import com.zx.shopmanagementsystem.barchart.ModelChart;
import com.zx.shopmanagementsystem.chart.ModelData;
import com.zx.shopmanagementsystem.dbconnection.JDBC;
import com.zx.shopmanagementsystem.ui.AllSales;
import com.zx.shopmanagementsystem.ui.LowStock;
import java.awt.Color;
import java.io.FileInputStream;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.Timer;
import java.util.TimerTask;

/**
 *
 * @author User
 */
public class HomeAdmin extends javax.swing.JPanel {

    /**
     * Creates new form Home
     */
    JDBC DB = new JDBC();
    private List<String> stockItems = new ArrayList<>();
    private List<String> stockLocations = new ArrayList<>();
    private int currentIndex = 0;
    int quantityValue;

    public HomeAdmin() {
        initComponents();
        jsonRead();
        setChart();
        setData();
        getDailySale();
        getMonthlySale();
        arrayLoader();
        Timer timer = new Timer();
        long delay = 2000; // Initial delay in milliseconds
        // Repeat every 5 seconds (5000 milliseconds)
        timer.schedule(new DisplayTask(), delay, 5000);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        totalMonthSaleTxt = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        itemName = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        store_Location = new javax.swing.JLabel();
        jLabel1 = new javax.swing.JLabel();
        totalDailySaleTxt = new javax.swing.JLabel();
        lowStockBtnLbl = new javax.swing.JLabel();
        todaySalseViewAllBtnLbl = new javax.swing.JLabel();
        monthlySalseViewAllBtnLbl = new javax.swing.JLabel();
        card3 = new javax.swing.JLabel();
        card2 = new javax.swing.JLabel();
        card1 = new javax.swing.JLabel();
        roundedGradiantPanal1 = new com.zx.shopmanagementsystem.components.RoundedGradiantPanal();
        chart = new com.zx.shopmanagementsystem.barchart.Chart();
        iconLbl = new javax.swing.JLabel();

        setPreferredSize(new java.awt.Dimension(1116, 718));
        setVerifyInputWhenFocusTarget(false);
        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        totalMonthSaleTxt.setFont(new java.awt.Font("Segoe UI", 1, 24)); // NOI18N
        totalMonthSaleTxt.setForeground(new java.awt.Color(255, 255, 255));
        totalMonthSaleTxt.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        add(totalMonthSaleTxt, new org.netbeans.lib.awtextra.AbsoluteConstraints(380, 180, 250, 80));

        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(255, 255, 255));
        jLabel2.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel2.setText("Monthly Sales");
        add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(370, 140, 270, -1));

        jLabel3.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        jLabel3.setForeground(new java.awt.Color(255, 255, 255));
        jLabel3.setText("Low Stock Alart");
        add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(770, 140, 110, -1));

        jLabel7.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        jLabel7.setForeground(new java.awt.Color(255, 255, 255));
        jLabel7.setText("Item Name");
        add(jLabel7, new org.netbeans.lib.awtextra.AbsoluteConstraints(720, 170, 200, 30));

        itemName.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        itemName.setForeground(new java.awt.Color(255, 255, 255));
        itemName.setText("Item Name");
        add(itemName, new org.netbeans.lib.awtextra.AbsoluteConstraints(720, 190, 200, 30));

        jLabel8.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        jLabel8.setForeground(new java.awt.Color(255, 255, 255));
        jLabel8.setText("Store Location");
        add(jLabel8, new org.netbeans.lib.awtextra.AbsoluteConstraints(720, 220, 200, 30));

        store_Location.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        store_Location.setForeground(new java.awt.Color(255, 255, 255));
        store_Location.setText("Store Location");
        add(store_Location, new org.netbeans.lib.awtextra.AbsoluteConstraints(720, 240, 200, 30));

        jLabel1.setFont(new java.awt.Font("Segoe UI", 1, 14)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(255, 255, 255));
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("Today Sales");
        add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(60, 140, 270, -1));

        totalDailySaleTxt.setFont(new java.awt.Font("Segoe UI", 1, 24)); // NOI18N
        totalDailySaleTxt.setForeground(new java.awt.Color(255, 255, 255));
        totalDailySaleTxt.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        add(totalDailySaleTxt, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 180, 250, 80));

        lowStockBtnLbl.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\icons\\ShowAll3.png")); // NOI18N
        lowStockBtnLbl.setPreferredSize(new java.awt.Dimension(287, 39));
        lowStockBtnLbl.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                lowStockBtnLblMouseClicked(evt);
            }
        });
        add(lowStockBtnLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(672, 270, 290, -1));

        todaySalseViewAllBtnLbl.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\icons\\ShowAll1.png")); // NOI18N
        todaySalseViewAllBtnLbl.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                todaySalseViewAllBtnLblMouseClicked(evt);
            }
        });
        add(todaySalseViewAllBtnLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(52, 270, 290, 50));

        monthlySalseViewAllBtnLbl.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\icons\\ShowAll2.png")); // NOI18N
        monthlySalseViewAllBtnLbl.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                monthlySalseViewAllBtnLblMouseClicked(evt);
            }
        });
        add(monthlySalseViewAllBtnLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(362, 270, 290, 40));

        card3.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\images\\3rd Rectangle.png")); // NOI18N
        add(card3, new org.netbeans.lib.awtextra.AbsoluteConstraints(670, 120, -1, -1));

        card2.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\images\\2nd Rectangle.png")); // NOI18N
        add(card2, new org.netbeans.lib.awtextra.AbsoluteConstraints(360, 120, -1, -1));

        card1.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\images\\1st Rectangle.png")); // NOI18N
        add(card1, new org.netbeans.lib.awtextra.AbsoluteConstraints(50, 120, -1, -1));

        roundedGradiantPanal1.setendColor(new java.awt.Color(102, 102, 102));
        roundedGradiantPanal1.setStartColor(new java.awt.Color(153, 153, 153));

        chart.setOpaque(false);

        javax.swing.GroupLayout roundedGradiantPanal1Layout = new javax.swing.GroupLayout(roundedGradiantPanal1);
        roundedGradiantPanal1.setLayout(roundedGradiantPanal1Layout);
        roundedGradiantPanal1Layout.setHorizontalGroup(
            roundedGradiantPanal1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(roundedGradiantPanal1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(chart, javax.swing.GroupLayout.DEFAULT_SIZE, 1048, Short.MAX_VALUE)
                .addContainerGap())
        );
        roundedGradiantPanal1Layout.setVerticalGroup(
            roundedGradiantPanal1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(roundedGradiantPanal1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(chart, javax.swing.GroupLayout.PREFERRED_SIZE, 360, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        add(roundedGradiantPanal1, new org.netbeans.lib.awtextra.AbsoluteConstraints(26, 330, 1060, 370));

        iconLbl.setIcon(new javax.swing.ImageIcon("C:\\ShopManagementSystem\\src\\main\\java\\com\\zx\\shopmanagementsystem\\images\\AdminDashboard.png")); // NOI18N
        iconLbl.setPreferredSize(new java.awt.Dimension(1116, 718));
        add(iconLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, -1, -1));
    }// </editor-fold>//GEN-END:initComponents

    private void lowStockBtnLblMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lowStockBtnLblMouseClicked
        // TODO add your handling code here:
        LowStock ls = new LowStock();
        ls.setVisible(true);
    }//GEN-LAST:event_lowStockBtnLblMouseClicked

    private void todaySalseViewAllBtnLblMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_todaySalseViewAllBtnLblMouseClicked
        // TODO add your handling code here:
        AllSales as = new AllSales(0);
        as.setVisible(true);
    }//GEN-LAST:event_todaySalseViewAllBtnLblMouseClicked

    private void monthlySalseViewAllBtnLblMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_monthlySalseViewAllBtnLblMouseClicked
        // TODO add your handling code here:
        AllSales as = new AllSales(1);
        as.setVisible(true);
    }//GEN-LAST:event_monthlySalseViewAllBtnLblMouseClicked

    class DisplayTask extends TimerTask {

        @Override
        public void run() {
            if (currentIndex < stockItems.size()) {
                String currentItem = stockItems.get(currentIndex);
                String storeLocation = stockLocations.get(currentIndex);
                itemName.setText(currentItem);
                store_Location.setText(storeLocation);
                currentIndex++;
            } else {
                // Reset to the beginning when all items are displayed
                currentIndex = 0;
            }
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel card1;
    private javax.swing.JLabel card2;
    private javax.swing.JLabel card3;
    private com.zx.shopmanagementsystem.barchart.Chart chart;
    private javax.swing.JLabel iconLbl;
    private javax.swing.JLabel itemName;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel lowStockBtnLbl;
    private javax.swing.JLabel monthlySalseViewAllBtnLbl;
    private com.zx.shopmanagementsystem.components.RoundedGradiantPanal roundedGradiantPanal1;
    private javax.swing.JLabel store_Location;
    private javax.swing.JLabel todaySalseViewAllBtnLbl;
    private javax.swing.JLabel totalDailySaleTxt;
    private javax.swing.JLabel totalMonthSaleTxt;
    // End of variables declaration//GEN-END:variables

    private void setChart() {
        chart.addLegend("Sales", Color.decode("#f56942"));
        chart.addLegend("Profit", Color.decode("#00fa21"));
    }

    private void setData() {
        try {
            List<ModelData> list = new ArrayList<>();
            ResultSet rs = DB.getdata("SELECT \n"
                    + "    DATE_FORMAT(date, '%Y-%m-%d') AS formatted_date,\n"
                    + "    SUM(sale) AS total_sales,\n"
                    + "    SUM(profit) AS total_profit\n"
                    + "FROM shopdb.user_profile\n"
                    + "WHERE date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)\n"
                    + "GROUP BY formatted_date\n"
                    + "ORDER BY formatted_date;");
            while (rs.next()) {
                String date = rs.getString("formatted_date");
                double sale = Double.parseDouble(rs.getString("total_sales"));
                double profit = Double.parseDouble(rs.getString("total_profit"));
                list.add(new ModelData(date, sale, profit));
            }
            rs.close();

            for (ModelData d : list) {
                chart.addData(new ModelChart(d.getDate(), new double[]{d.getSale(), d.getProfit()}));
            }
            chart.start();
        } catch (Exception ex) {
            System.err.println("Analisis SetData : " + ex.getMessage());
        }
    }

    private void arrayLoader() {
        String sql = "SELECT p.product_name, s.store_location_name\n"
                + "FROM shopdb.product p\n"
                + "JOIN shopdb.store_location s ON p.store_location_id = s.store_location_id\n"
                + "WHERE p.stock_quantity <= " + quantityValue + ";";
        try {
            ResultSet rs = DB.getdata(sql);
            ResultSet rs1 = DB.getdata(sql);
            if (!rs.next()) {
                itemName.setText("No Items to Show");
                store_Location.setText("No Items to Show");
            } else {
                System.out.println("ResultSet Not Empty");
                while (rs1.next()) {
                    stockItems.add(rs1.getString("product_name"));
                    stockLocations.add(rs1.getString("store_location_name"));
                }
            }
        } catch (Exception ex) {
            System.err.println("ArrayLoader : " + ex.getMessage());
        }
    }

    private void getDailySale() {
        String sql = "SELECT SUM(sale) AS total_sales\n"
                + "FROM shopdb.user_profile\n"
                + "WHERE DATE(date) = CURDATE();";

        try {
            ResultSet rs = DB.getdata(sql);

            if (rs.next()) {
                if (rs.getString("total_sales") == null) {
                    totalDailySaleTxt.setText("No Record");
                } else {
                    totalDailySaleTxt.setText("Rs." + rs.getString("total_sales") + "0/=");
                }
            }
        } catch (Exception ex) {
            System.err.println("getDailySale -> Home Admin : " + ex.getMessage());
        }
    }

    private void getMonthlySale() {
        String sql = "SELECT SUM(sale) AS total_sales\n"
                + "FROM shopdb.user_profile\n"
                + "WHERE YEAR(date) = YEAR(CURDATE()) AND MONTH(date) = MONTH(CURDATE());";

        try {
            ResultSet rs = DB.getdata(sql);
            if (rs.next()) {
                if (rs.getString("total_sales") == null) {
                    totalMonthSaleTxt.setText("No Record");
                } else {
                    totalMonthSaleTxt.setText("Rs." + rs.getString("total_sales") + "0/=");
                }
            }
        } catch (Exception ex) {
            System.err.println("getMonthlySale -> Home Admin : " + ex.getMessage());
        }
    }

    private void jsonRead() {
        Properties properties = new Properties();
        try (FileInputStream fileInputStream = new FileInputStream("Settings.properties")) {
            properties.load(fileInputStream);
            System.out.println("Settings loaded successfully.");

            // Access individual properties
            quantityValue = Integer.parseInt((properties.getProperty("LowStockAlert")));
        } catch (Exception en) {
            System.err.println("Home Admin LowStockAlert : " + en);
        }
    }
}
